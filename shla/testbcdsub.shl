//
// Test for BCD arithmetic with SHLA
// First round: One dight per mem cell
// In-memory format is one count word and <count> digit words
//

#pragma read bcd.dat@heap
#pragma print z1[10],z2[10],res[10]

var z1[10], z2[10], res[10], d, e, x, y, u, i;

sub readbcd(ref v, l) {
  // read bcd from data
  i <- 1;
  loop {
    read d;
    stop on(d > 9);
    v[i] <- d;
    i <- i + 1;
  }
  v[0] <- i - 1;
}

sub sumbcd(ref a, ref b, ref c) {
  i <- 1;
  u <- 0;
  e <- 0;
  loop {
    x <- a[i];
    if(a[0] < i) {
      x <- 0;
      e <- e + 1;
    }
    y <- b[i];
    if(b[0] < i) {
      y <- 0;
      e <- e + 1;
    }
    stop on(e > 1);
    d <- x + y + u;		// sum digits and carry
    if(d > 9) {		 	// overflow
      u <- 1;			// new carry
      d <- d - 10;		// digit is 9
    } else {
      u <- 0;
    }
    c[i] <- d;
    i <- i + 1;
  }
  if(u > 0) {
    c[i] <- u;			// final carry is msd
    i <- i + 1;
  }
  c[0] <- i - 1;		// result digit count
}

main {
  call readbcd(z1, 10);
  call readbcd(z2, 10);  
  // compute a + b
  call sumbcd(z1, z2, res);
}
