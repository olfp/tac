; shlc SHLA compilation Tue Aug  7 20:38:03 2018
; this assumes a TAC with 10 bit word width
; mem locs 1-255 are local local or temporary vars
RESET:	JMP MAIN
STKPTR:	MEM 255
FRMPTR:	MEM 255
.=	256
#PRAGMA	bits 12
#PRAGMA	read bcd.dat@heap
#PRAGMA	print z1[10],z2[10],res[10]
z1=	MEM 0*10
z2=	MEM 0*10
res=	MEM 0*10
d=	MEM 0
dx=	MEM 0
dy=	MEM 0
e=	MEM 0
x=	MEM 0
y=	MEM 0
u=	MEM 0
w=	MEM 0
ndig=	MEM 0
subdig=	MEM 0
i=	MEM 0
grp=	MEM 0
digpergrp=	MEM 3
putbcd:	MEM 0
	ADD FRMPTR #1 16
	MOV putbcd *16
L00001:	SUB FRMPTR #3 16
	CMP *16 #1
	JLE L00002
	SUB FRMPTR #0 16
	SHL *16 16
	SHL 16 16
	SHL 16 16
	SHL 16 16
	SUB FRMPTR #0 17
	MOV @16 *17
	SUB FRMPTR #3 17
	SUB *17 #1 18
	SUB FRMPTR #3 19
	MOV @18 *19
	JMP L00001
L00002:	SUB FRMPTR #1 19
	MOV *19 19
	SUB FRMPTR #2 19
	ADD @19 *19 19
	SUB FRMPTR #1 20
	MOV *20 20
	SUB FRMPTR #2 20
	ADD @20 *20 20
	SUB FRMPTR #0 22
	IOR *20 *22 23
	MOV @23 *19
	MOV FRMPTR STKPTR
	ADD STKPTR #1 STKPTR
	MOV *STKPTR 24
	ADD STKPTR #1 STKPTR
	MOV *STKPTR FRMPTR
	JMP *24
getbcd:	MEM 0
	ADD FRMPTR #1 24
	MOV getbcd *24
	SUB FRMPTR #1 24
	MOV *24 24
	SUB FRMPTR #2 24
	ADD @24 *24 24
	SUB FRMPTR #0 25
	MOV *25 25
	MOV *24 *25
L00003:	SUB FRMPTR #3 25
	CMP *25 #1
	JLE L00004
	SUB FRMPTR #0 25
	MOV *25 25
	SHR *25 25
	SHR 25 25
	SHR 25 25
	SHR 25 25
	SUB FRMPTR #0 26
	MOV *26 26
	MOV @25 *26
	SUB FRMPTR #3 26
	SUB *26 #1 27
	SUB FRMPTR #3 28
	MOV @27 *28
	JMP L00003
L00004:	SUB FRMPTR #0 28
	MOV *28 28
	AND *28 #15 29
	SUB FRMPTR #0 30
	MOV *30 30
	MOV @29 *30
	MOV FRMPTR STKPTR
	ADD STKPTR #1 STKPTR
	MOV *STKPTR 30
	ADD STKPTR #1 STKPTR
	MOV *STKPTR FRMPTR
	JMP *30
readbcd2p:	MEM 0
	ADD FRMPTR #1 30
	MOV readbcd2p *30
	MOV #0 subdig
	MOV #1 ndig
	MOV #1 grp
L00005:	MOV *DATPTR d
	ADD DATPTR #1 DATPTR
	CMP d #9
	JGT L00006
	AND d #15 31
	MOV FRMPTR 16
	MOV FRMPTR *STKPTR
	SUB STKPTR #2 STKPTR
	MOV STKPTR FRMPTR
	MOV @31 *STKPTR
	SUB STKPTR #1 STKPTR
	SUB 16 #0 17
	MOV *17 17
	MOV 17 *STKPTR
	SUB STKPTR #1 STKPTR
	MOV grp *STKPTR
	SUB STKPTR #1 STKPTR
	MOV subdig *STKPTR
	SUB STKPTR #1 STKPTR
	JSR putbcd
	ADD ndig #1 18
	MOV @18 ndig
	ADD subdig #1 20
	MOV @20 subdig
	CMP subdig digpergrp
	JLE L00007
	MOV #0 subdig
	ADD grp #1 22
	MOV @22 grp
L00007:	JMP L00005
L00006:	SUB FRMPTR #0 23
	MOV *23 23
	ADD @23 #0 23
	SUB ndig #1 25
	MOV @25 *23
	MOV FRMPTR STKPTR
	ADD STKPTR #1 STKPTR
	MOV *STKPTR 26
	ADD STKPTR #1 STKPTR
	MOV *STKPTR FRMPTR
	JMP *26
sumbcd:	MEM 0
	ADD FRMPTR #1 26
	MOV sumbcd *26
	MOV #0 u
	MOV #1 i
	MOV #1 grp
	MOV #0 subdig
L00008:	MOV #0 e
	SUB FRMPTR #0 26
	MOV *26 26
	ADD @26 #0 26
	CMP *26 i
	JEQ L00009
	JGT L00009
	MOV #0 dx
	ADD e #1 28
	MOV @28 e
	JMP L00010
L00009:	MOV FRMPTR 29
	MOV FRMPTR *STKPTR
	SUB STKPTR #2 STKPTR
	MOV STKPTR FRMPTR
	MOV #dx *STKPTR
	SUB STKPTR #1 STKPTR
	SUB 29 #0 30
	MOV *30 30
	MOV 30 *STKPTR
	SUB STKPTR #1 STKPTR
	MOV grp *STKPTR
	SUB STKPTR #1 STKPTR
	MOV subdig *STKPTR
	SUB STKPTR #1 STKPTR
	JSR getbcd
L00010:	SUB FRMPTR #1 30
	MOV *30 30
	ADD @30 #0 30
	CMP *30 i
	JEQ L00011
	JGT L00011
	MOV #0 dy
	ADD e #1 16
	MOV @16 e
	JMP L00012
L00011:	MOV FRMPTR 17
	MOV FRMPTR *STKPTR
	SUB STKPTR #2 STKPTR
	MOV STKPTR FRMPTR
	MOV #dy *STKPTR
	SUB STKPTR #1 STKPTR
	SUB 17 #1 18
	MOV *18 18
	MOV 18 *STKPTR
	SUB STKPTR #1 STKPTR
	MOV grp *STKPTR
	SUB STKPTR #1 STKPTR
	MOV subdig *STKPTR
	SUB STKPTR #1 STKPTR
	JSR getbcd
L00012:	CMP e #1
	JGT L00013
	ADD dx dy 20
	ADD @20 u 23
	MOV @23 d
	CMP d #9
	JEQ L00014
	JLE L00014
	MOV #1 u
	SUB d #10 25
	MOV @25 d
	JMP L00015
L00014:	MOV #0 u
L00015:	MOV FRMPTR 26
	MOV FRMPTR *STKPTR
	SUB STKPTR #2 STKPTR
	MOV STKPTR FRMPTR
	MOV d *STKPTR
	SUB STKPTR #1 STKPTR
	SUB 26 #2 27
	MOV *27 27
	MOV 27 *STKPTR
	SUB STKPTR #1 STKPTR
	MOV grp *STKPTR
	SUB STKPTR #1 STKPTR
	MOV subdig *STKPTR
	SUB STKPTR #1 STKPTR
	JSR putbcd
	ADD subdig #1 28
	MOV @28 subdig
	CMP subdig digpergrp
	JLE L00016
	MOV #0 subdig
	ADD grp #1 30
	MOV @30 grp
L00016:	ADD i #1 16
	MOV @16 i
	JMP L00008
L00013:	CMP u #0
	JEQ L00017
	JLE L00017
	MOV FRMPTR 17
	MOV FRMPTR *STKPTR
	SUB STKPTR #2 STKPTR
	MOV STKPTR FRMPTR
	MOV u *STKPTR
	SUB STKPTR #1 STKPTR
	SUB 17 #2 18
	MOV *18 18
	MOV 18 *STKPTR
	SUB STKPTR #1 STKPTR
	MOV grp *STKPTR
	SUB STKPTR #1 STKPTR
	MOV subdig *STKPTR
	SUB STKPTR #1 STKPTR
	JSR putbcd
	ADD i #1 19
	MOV @19 i
L00017:	SUB FRMPTR #2 20
	MOV *20 20
	ADD @20 #0 20
	SUB i #1 22
	MOV @22 *20
	MOV FRMPTR STKPTR
	ADD STKPTR #1 STKPTR
	MOV *STKPTR 23
	ADD STKPTR #1 STKPTR
	MOV *STKPTR FRMPTR
	JMP *23
MAIN:	MOV FRMPTR 23
	MOV FRMPTR *STKPTR
	SUB STKPTR #2 STKPTR
	MOV STKPTR FRMPTR
	MOV #z1 *STKPTR
	SUB STKPTR #1 STKPTR
	JSR readbcd2p
	MOV FRMPTR 24
	MOV FRMPTR *STKPTR
	SUB STKPTR #2 STKPTR
	MOV STKPTR FRMPTR
	MOV #z2 *STKPTR
	SUB STKPTR #1 STKPTR
	JSR readbcd2p
	MOV FRMPTR 25
	MOV FRMPTR *STKPTR
	SUB STKPTR #2 STKPTR
	MOV STKPTR FRMPTR
	MOV #z1 *STKPTR
	SUB STKPTR #1 STKPTR
	MOV #z2 *STKPTR
	SUB STKPTR #1 STKPTR
	MOV #res *STKPTR
	SUB STKPTR #1 STKPTR
	JSR sumbcd
	HLT
HEAP:	MEM 0
